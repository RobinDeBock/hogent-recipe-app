<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Put app on Heroku</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.13/semantic.min.css">
</head>

<body>
    <div class='ui container'>
        <h3>put your app on heroku</h3>
        <p>
            So we decided to put our app on Heroku (because heroku is free and we're cheap), until now our app consisted of two parts,
            the Angular frontend, and the NodeJs backend. We basically have two servers: one, obviously the NodeJS server,
            which serves our REST API; but also the Angular frontend. What we're really accessing is a compiled version of
            our app, served by Webpack.
        </p>
        <p>
            When we start a 'ng serve' the first thing we always see is a compile step.
            <img class='ui fluid image' src="img/heroku_ng_build.png" alt=""> And it's THOSE files that end up in our browser and render our app, not all the different typescript components
            and services etc. Those are merely the source code to create our webapp, which consists of one html file and
            a few plain javascript files.
        </p>
        <p>
            While these files are what we want to serve, they are nowhere to be found on our drive. When you do a ng serve, these files
            get built but only exist in memory. In order to create them you have to explicitly call 'ng build' 'ng build'
            creates a dist/ folder with all the files we need to serve our app, adding these files to the public/ folder
            of our nodejs app and adding a route so every request ends up in the (one) index.html file we have would actually
            be sufficient.
        </p>
        <p>
            But we can do better, heroku knows how to build Angular apps, we can add all our typescript code and have it rebuild our
            app everytime we push a change. So in the end we will have our Angular app on a heroku git repository, push changes,
            and a minute later our changed app will be live.
        </p>
        <div class="ui horizontal divider">create heroku app</div>
        <p>
            But to do this, we need more than just the dist/ folder, we need to merge everything from the Angular app. So we want everything
            to be in one folder, and that folder should be the root of our git repository (as that is where heroku will look
            for a package.json which tells him what to do)
        </p>
        <p>We start by installing the
            <a href="https://devcenter.heroku.com/articles/heroku-cli">heroku-cli</a>, check that it is installed correctly using 'heroku -v'
        </p>
        <p>Now go to the 'root' folder of your app, it's probably a folder which contains two other folder frontend/ and backend/,
            in this folder do 'heroku create'. This will create a new app on heroku, with a random name, and associate a
            remote heroku git with the existing repository.
        </p>
        <div class="ui horizontal divider">merge apps</div>

        <p>
            Now we want everything we need from both the frontend/ and the backend/ folder to move up one level, into this folder. To
            keep this explanation a bit more brief, we'll ignore all test files, and only move those files we really need
            for our app to function.
            <br/>
            <div class="ui large images">
                <img src="img/heroku_nodejs_folder.png" alt="">
                <img src="img/heroku_angular_folder.png" alt="">
            </div>
        </p>
        <p>
            Obviously we need 'both' package.json dependencies, so we'll copy all dependencies from one into the other. This will result
            in a 'merged' node_modules/ folder too (you shouldn't copy anything from or to a node_modules folder, it will
            be regenerated by the merged package.json)
            <img class='ui centered small image' src="img/heroku_node_angular_folder.png" alt="">

        </p>
        <p>
            Simply copying all nodejs dependencies to the package.json dependencies of the angular folder is not enough though. Heroku
            will ignore everything inside the devDependencies part. But some of those we need build our app (angular-cli,
            ...), so we have to move those from the devDependencies to the dependencies.
            <img class='ui centered large image' src="img/heroku_package_json.png" alt="">
        </p>
        <div class="ui horizontal divider">package.json scripts</div>

        <p>
            Now we still need to update the scripts of our package.json, we don't want to start a webpack server, we want to start our
            nodejs server (and have him serve our angular app files too). Every time we push an update to heroku, it will
            by default run an 'npm install', so we'd want the npm install to also rebuild our app in the dist/ folder, this
            can be done by adding a postinstall step.
            <img class='ui medium image' src="img/heroku_package_json_scripts.png" alt="">
        </p>
        <div class="ui horizontal divider">nodejs routes</div>

        <p>
            Next part, we need to add some routes to our app.js of the backend. We already have routes for all our backend /API calls,
            but now we want to serve the index.html, and all the generated javascript files, from the dist folder. On top
            of that we want all other urls (e.g. http://ourapp/recipe/list/ ) to also return this index.html file, the Angular
            router will take care of rendering the correct components inside this html file.
            <pre><code>
                    app.use(express.static(__dirname + '/dist'));
                    
                    app.all('*', (req, res) => {
                      const indexFile = `${path.join(__dirname, 'dist')}/index.html`;
                      res.status(200).sendFile(indexFile);
                    }); </code></pre>
        </p>
        <div class="ui horizontal divider">mongodb</div>

        <p>
            We still need a database, you can link mongodb plugins to your heroku app and get a (free) database that way, but you always
            have to add a credit card if you want to use plugins (even if you would never get charged).
            <br/> Since many students don't have credit cards, we'll link a database manually. Go to
            <a href="https://mlab.com/">mlab.com</a>, make an account, create a database for your app, and add a database user to it, in the end you
            should be able to access it through a url, something like:
            <pre><code>       mongodb://myuser:mypassword@somerandomstring12.mlab.com</code></pre>
        </p>
        <div class="ui horizontal divider">environment variables</div>
        <p>
            We rely on a few environment variables to set our backend secret to secure our token, and to know where our database is.
            Go to the settings part of your app and the heroku website and set the environment variables there.
            <img src="img/heroku_herokusettings.png" alt="" class="ui image">
        </p>
        <div class="ui horizontal divider">test and run</div>

        <p>
            That's it, go to your folder and try
            <pre><code>         heroku local web</code></pre> to test everything locally, server can by default be found at
            <a href="http://localhost:5000/">http://localhost:5000</a>
        </p>
        <p>
            Now to get everything running live, do
            <pre><code>         git push heroku master</code></pre> you'll see the output of the remote server, and if all is well after a minute or so your app is accessible on
            the web.
        </p>
        <div class="ui horizontal divider">production build</div>
        <p>
            Better still, is to create an optimised production build, and put that online. It will be smaller (and faster), this is achieved
            by performing
            <pre><code>          ng build -prod</code></pre> instead of the regular ng build.
            <br/>If you do this the first time it's not unlikely you'll bump into some errors, the two most common ones are:
            <ul>
                <li>using private i.s.o. public for properties you use outside your class (private variables are aggressively
                    minified, so they can't be found anymore), this is fixed by making those properties public</li>
                <li>accessing FormArray's as AbstractControls (which doesn't have a .controls property), this is fixed by adding
                    a getter to the .ts file which explicitly casts.</li>
            </ul>
        </p>
    </div>
</body>

</html>